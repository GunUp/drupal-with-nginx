# -*- mode: nginx; mode: flyspell-prog;  ispell-current-dictionary: american -*-
### Configuration for s/reload/www.gunup.com.

# Deny requests for non-specified domains.
#server {
#    listen 80;
#    server_name migrate.gunup.com;
#    return 444;
#}

## HTTP server.

# (always) redirect http://gunup.com/* to http://www.gunup.com/*
#server {
#  listen 80;
#  server_name migrate.gunup.com;
#  return 301 $scheme://migrate.gunup.com$request_uri;
#}

server {
    listen 80; # IPv4
    ## Replace the IPv6 address by your own address. The address below
    ## was stolen from the wikipedia page on IPv6.
    # fe80::4240:8ff:feef:6f60 = GunUp 'marketing/staging' server
    #listen [fe80::4240:8ff:feef:6f60]:80 ipv6only=on;

    server_name migrate.gunup.com;
    limit_conn arbeit 1024;

    ## Access and error logs.
    access_log /var/log/nginx/migrate.gunup.com_access.log;
    error_log /var/log/nginx/migrate.gunup.com_error.log;

    ## See the blacklist.conf file at the parent dir: /etc/nginx.
    ## Deny access based on the User-Agent header.
    if ($bad_bot) {
        return 444;
    }
    ## Deny access based on the Referer header.
    if ($bad_referer) {
        return 444;
    }

    ## Protection against illegal HTTP methods. Out of the box only HEAD,
    ## GET and POST are allowed.
    if ($not_allowed_method) {
        return 405;
    }

    ## Filesystem root of the site and index.
    root /var/www/sites/migrate.gunup.com;
    index index.php;
    
    ## If you're using a Nginx version greater or equal to 1.1.4 then
    ## you can use keep alive connections to the upstream be it
    ## FastCGI or Apache. If that's not the case comment out the line below.
    fastcgi_keep_conn on; # keep alive to the FCGI upstream

    ## Uncomment if you're proxying to Apache for handling PHP.
    #proxy_http_version 1.1; # keep alive to the Apache upstream

    ################################################################
    ### Generic configuration: for most Drupal 7 sites.
    ################################################################
    include sites-available/drupal.conf;

    #################################################################
    ### Configuration for Drupal 7 sites that use boost.
    #################################################################
    #include sites-available/drupal_boost.conf;

    #################################################################
    ### Configuration for updating the site via update.php and running
    ### cron externally. If you don't use drush for running cron use
    ### the configuration below.
    #################################################################
    #include sites-available/drupal_cron_update.conf;

    ## For upload progress to work. From the README of the
    ## filefield_nginx_progress module.
    location ~ ^(.*)/x-progress-id:(\w*) {
        return 302 $1?X-Progress-ID=$2;
    }

    location ^~ /progress {
#        report_uploads uploads;
    }

    ## Including the php-fpm status and ping pages config.
    ## Uncomment to enable if you're running php-fpm.
    include php_fpm_status_vhost.conf;

    ## Including the Nginx stub status page for having stats about
    ## Nginx activity: http://wiki.nginx.org/HttpStubStatusModule.
    include nginx_status_vhost.conf;

    ## static file rewrites for publishing tools
    include sites-available/publishing_tools.conf;

    ## explicit pass-thru for GunUp.com ad-serving php script
    location = /sites/all/modules/ad/serve.php {
      fastcgi_pass phpcgi;
    }

    location = /marketplace/index.php {
      fastcgi_pass phpcgi;
    }

    location ~* ^.+\.(xml)$ {
        try_files $uri $uri/ /index.php?q=$uri&$args;
    }
    
    # location ~* ^.+.xml$ {
    #     rewrite ^ /index.php?q=$uri;
    # }

} # HTTP server


## HTTPS server.
#server {
#    listen 443 ssl;
    ## Replace the IPv6 address by your own address. The address below
    ## was stolen from the wikipedia page on IPv6.
#    listen [fe80::202:b3ff:fe1e:8329]:443 ssl ipv6only=on;

#    server_name reload.gunup.com;
#    limit_conn arbeit 32;

    ## Access and error logs.
#    access_log /var/log/nginx/reload.gunup.com_access.log;
#    error_log /var/log/nginx/reload.gunup.com_error.log;

    ## Keep alive timeout set to a greater value for SSL/TLS.
#    keepalive_timeout 75 75;

    ## See the keepalive_timeout directive in nginx.conf.
    ## Server certificate and key.
#    ssl_certificate /etc/ssl/certs/example-cert.pem;
#    ssl_certificate_key /etc/ssl/private/example.key;

    ## Strict Transport Security header for enhanced security. See
    ## http://www.chromium.org/sts. I've set it to 2 hours; set it to
    ## whichever age you want.
#    add_header Strict-Transport-Security "max-age=7200";

#    root /var/www/sites/reload.gunup.com;
#    index index.php;

    ## If you're using a Nginx version greater or equal to 1.1.4 then
    ## you can use keep alive connections to the upstream be it
    ## FastCGI or Apache. If that's not the case comment out the line below.
#    fastcgi_keep_conn on; # keep alive to the FCGI upstream

    ## Uncomment if you're proxying to Apache for handling PHP.
    #proxy_http_version 1.1; # keep alive to the Apache upstream

    ## See the blacklist.conf file at the parent dir: /etc/nginx.
    ## Deny access based on the User-Agent header.
#    if ($bad_bot) {
#        return 444;
#    }
    ## Deny access based on the Referer header.
#    if ($bad_referer) {
#        return 444;
#    }

    ## Protection against illegal HTTP methods. Out of the box only HEAD,
    ## GET and POST are allowed.
#    if ($not_allowed_method) {
#        return 405;
#    }

    ################################################################
    ### Generic configuration: for most Drupal 7 sites.
    ################################################################
#    include sites-available/drupal.conf;

    ################################################################
    ### Generic configuration: for most Drupal 6 sites.
    ################################################################
    # include sites-available/drupal6.conf;

    #################################################################
    ### Configuration for Drupal 7 sites that use boost.
    #################################################################
    #include sites-available/drupal_boost.conf;

    #################################################################
    ### Configuration for Drupal 6 sites that use boost.
    #################################################################
    #include sites-available/drupal_boost6.conf;

    #################################################################
    ### Configuration for updating the site via update.php and running
    ### cron externally. If you don't use drush for running cron use
    ### the configuration below.
    #################################################################
    #include sites-available/drupal_cron_update.conf;

    ## For upload progress to work. From the README of the
    ## filefield_nginx_progress module.
#    location ~ ^(.*)/x-progress-id:(\w*) {
#        return 302 $1?X-Progress-ID=$2;
#    }

#    location ^~ /progress {
#        report_uploads uploads;
#    }

    ## Including the php-fpm status and ping pages config.
    ## Uncomment to enable if you're running php-fpm.
    #include php_fpm_status.conf;

    ## Including the Nginx stub status page for having stats about
    ## Nginx activity: http://wiki.nginx.org/HttpStubStatusModule.
#    include nginx_status_vhost.conf;

#} # HTTPS server
